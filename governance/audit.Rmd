Audit figures
========================================================

```{r warning=FALSE,results='hide',echo=TRUE,message=FALSE}
library(synapseClient)
synapseLogin()
#library(lubridate)
library(ggplot2)
library(scales)
```

###Get folder ids
```{r}
qr = synQuery("select id, name from entity where parentId=='syn2495369'")
projects_files = qr$entity.id[which(qr$entity.name == "projects_files")]
user_activities = qr$entity.id[which(qr$entity.name == "users_activities")]
```


## Projects

###Pie/Dot charts of current audit period composition
```{r fig.width=10}
qr = synQuery(paste("select id, name from entity where parentId=='", projects_files, "'", sep = ""))
projects_current_audit_entity = synGet(qr$entity.id[which(qr$entity.name == "project_counts_current_audit_period.txt")])
projects_current_audit = read.delim(getFileLocation(projects_current_audit_entity), sep = ":", head = FALSE)
pie(projects_current_audit$V2[c(2,3,5,6)],labels=substr(projects_current_audit$V1[c(2,3,5,6)],start=10,stop=60), main = "new projects \n current audit period", cex = 0.9)
```
```{r}
dotchart(projects_current_audit$V2[c(2,3,5,6)],labels=substr(projects_current_audit$V1[c(2,3,5,6)],start=10,stop=60),bg="red", main="new projects -- current audit", xlab = "number of projects")
```

###Line charts of total over time -- don't actually have the data to make this plot (don't have counts per time)
```{r}
projects_snapshot_entity = synGet(qr$entity.id[grep("project_counts_snapshot", qr$entity.name)])
projects_snapshot = read.delim(getFileLocation(projects_snapshot_entity))
```



## Files


###Pie/Dot charts of current audit period composition
```{r fig.width=10}
files_current_audit_entity = synGet(qr$entity.id[which(qr$entity.name == "file_counts_current_audit_period.txt")])
files_current_audit = read.delim(getFileLocation(files_current_audit_entity), sep = ":", head = FALSE)
pie(files_current_audit$V2[c(2,3,5,6)],labels=substr(files_current_audit$V1[c(2,3,5,6)],start=10,stop=60), main = "new files \n current audit period", cex = 0.9)
```
```{r}
dotchart(files_current_audit$V2[c(2,3,5,6)],labels=substr(files_current_audit$V1[c(2,3,5,6)],start=10,stop=60),bg="red", main="new files -- current audit period", xlab = "number of files")
```

### Which projects have controlled files?
```{r}
public_file_controlled_entity = synGet(qr$entity.id[grep("public_files_controlled_snapshot", qr$entity.name)])
public_file_controlled = read.csv(getFileLocation(public_file_controlled_entity))
table(public_file_controlled$PROJECT_NAME)
```

### Other plots? Not sure what would be helpful to see from this data...?
```{r}
public_file_uploads_ca_entity = synGet(qr$entity.id[grep("public_file_uploads_sage_current_audit_period.csv", qr$entity.name)])
public_file_uploads_ca = read.csv(getFileLocation(public_file_uploads_ca_entity))
head(public_file_uploads_ca)
```



## Users


### Active users -- days on synapse
```{r}
qr = synQuery(paste("select id, name from entity where parentId=='", user_activities, "'", sep = ""))
nonsage_users_entity = synGet(qr$entity.id[which(qr$entity.name == "active_non_sage_users.csv")])
nonsage_users = read.csv(getFileLocation(nonsage_users_entity), head = TRUE)
head(nonsage_users)
hist(nonsage_users$DAYS, col = "powderblue", main = "active non-Sage users", xlab = "number of days using Synapse during audit period", breaks = 20)
sage_users_entity = synGet(qr$entity.id[which(qr$entity.name == "active_sage_users.csv")])
sage_users = read.csv(getFileLocation(sage_users_entity), head = TRUE)
head(sage_users)
hist(sage_users$DAYS, col = "powderblue", main = "active Sage users", xlab = "number of days using Synapse during audit period", breaks = 20)
```

Not sure what to do with this data...?
```{r}
user_details_prj_entity = synGet(qr$entity.id[which(qr$entity.name == "user_details_projects.csv")])
user_details_prj = read.csv(getFileLocation(user_details_prj_entity), head = TRUE)
head(user_details_prj)
```






### Old code
Read in data and summarize at the month level.
```{r}
ns_users = read.csv("~/Documents/governance/documents-export-2014-05-06/non-sage-users-updated.csv")
creation = sapply(ns_users[,2],function(x) {substr(x,1,10)} )
creation_months = table(sapply(ns_users[,2],function(x) {substr(x,1,7)} ))
```

New users per month 
```{r}
# standard barpolot
barplot(creation_months, las = 2, main = "Users added per month", ylab = "number of new users")

# ggplot2 option
creation_months_df = as.data.frame(creation_months)
creation_months_df$date = as.Date(paste(creation_months_df[,1], "-28", sep=""))
ggplot(data=creation_months_df, aes(x=date, y=Freq)) + geom_bar(stat="identity") + ggtitle("Users added per month") + ylab("number of new users")
```

Total users over time
```{r}
# dotchart option
total_users = rep(NA,length(creation_months))
names(total_users) = names(creation_months)
total_users[1] = creation_months[1]
for (i in 2:length(creation_months)) {
  total_users[i] = total_users[i-1] + creation_months[i]
}
dotchart(total_users, main = "Total users over time", xlab = "total users")


# ggplot2 option
total_users_df = as.data.frame(total_users)
total_users_df$date = as.Date(paste(rownames(total_users_df), "-28", sep=""))
qplot(x=date, y = total_users, data=total_users_df, geom="line", main = "Total users over time", ylab = "total users")
#last_plot() + scale_x_date(breaks = date_breaks("3 months"))
```
