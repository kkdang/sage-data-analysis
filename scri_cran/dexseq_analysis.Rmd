---
title: "dexseq_analysis.Rmd"
author: "Kristen Dang"
date: "December 30, 2015"
output: html_document
---

```{r}
library(DEXSeq)
library(synapseClient)
synapseLogin()
source('~/Computing/external_software/load_SubreadOutput.R')
library('rGithubClient')
source('/Users/kristen/Computing/external_software/rgithubclient_authenticate.R')
sourceRepoFile(sageCode, "rnaseq_analysis_functions.R")
setwd('~/Computing/cranio/')
```

## Filter and convert metadata
```{r}
sourceRepoFile(sageCode, "scri_cran/process_metadata.R")
metadataFiltered = processMetadata(ver = 5,plot = FALSE)
metadataFiltered$Sample_Type = as.character(metadataFiltered$Sample_Type)
metadataFiltered$Sample_Type[grep("Coronal",metadataFiltered$Sample_Type)] = "Coronal"
metadataFiltered$Sample_Type[grep("Metopic",metadataFiltered$Sample_Type)] = "Metopic"
metadataFiltered$Sample_Type[grep("Sagittal",metadataFiltered$Sample_Type)] = "Sagittal"
metadataFiltered$Sample_Type = as.factor(metadataFiltered$Sample_Type)
```

## Get exon data and read into dexseq object
```{r}
exonCountsEnt = synGet('syn5568207')
exonCounts = read.delim(getFileLocation(exonCountsEnt), header=TRUE,stringsAsFactors = FALSE,row.names = 1)
gtfEnt = synGet('syn5386238')

colnames(exonCounts)
x = metadataFiltered$Px_Code[match(colnames(exonCounts), paste("X",metadataFiltered$SAMPLE, sep = ""))]
colnames(exonCounts) = x


# Remove these rows, they don't match the GTF
# "ENSG00000261934+ENSG00000253910+ENSG00000204956+ENSG00000253159+ENSG00000242419+ENSG00000253846+ENSG00000262209+ENSG00000253485+ENSG00000253767+ENSG00000240184+ENSG00000240764+ENSG00000253731+ENSG00000254221+ENSG00000081853+ENSG00000253305+ENSG00000254122:001"
# "ENSG00000261934+ENSG00000253910+ENSG00000204956+ENSG00000253159+ENSG00000242419+ENSG00000253846+ENSG00000262209+ENSG00000253485+ENSG00000253767+ENSG00000240184+ENSG00000240764+ENSG00000253731+ENSG00000254221+ENSG00000081853+ENSG00000253305+ENSG00000254122:002"
# "ENSG00000261934+ENSG00000253910+ENSG00000204956+ENSG00000253159+ENSG00000242419+ENSG00000253846+ENSG00000262209+ENSG00000253485+ENSG00000253767+ENSG00000240184+ENSG00000240764+ENSG00000253731+ENSG00000254221+ENSG00000081853+ENSG00000253305+ENSG00000254122:003"
# "ENSG00000261934+ENSG00000253910+ENSG00000204956+ENSG00000253159+ENSG00000242419+ENSG00000253846+ENSG00000262209+ENSG00000253485+ENSG00000253767+ENSG00000240184+ENSG00000240764+ENSG00000253731+ENSG00000254221+ENSG00000081853+ENSG00000253305+ENSG00000254122:004"
# "ENSG00000261934+ENSG00000253910+ENSG00000204956+ENSG00000253159+ENSG00000242419+ENSG00000253846+ENSG00000262209+ENSG00000253485+ENSG00000253767+ENSG00000240184+ENSG00000240764+ENSG00000253731+ENSG00000254221+ENSG00000081853+ENSG00000253305+ENSG00000254122:005"
# "ENSG00000261934+ENSG00000253910+ENSG00000204956+ENSG00000253159+ENSG00000242419+ENSG00000253846+ENSG00000262209+ENSG00000253485+ENSG00000253767+ENSG00000240184+ENSG00000240764+ENSG00000253731+ENSG00000254221+ENSG00000081853+ENSG00000253305+ENSG00000254122:006"
# "ENSG00000261934+ENSG00000253910+ENSG00000204956+ENSG00000253159+ENSG00000242419+ENSG00000253846+ENSG00000262209+ENSG00000253485+ENSG00000253767+ENSG00000240184+ENSG00000240764+ENSG00000253731+ENSG00000254221+ENSG00000081853+ENSG00000253305+ENSG00000254122:007"
# "ENSG00000261934+ENSG00000253910+ENSG00000204956+ENSG00000253159+ENSG00000242419+ENSG00000253846+ENSG00000262209+ENSG00000253485+ENSG00000253767+ENSG00000240184+ENSG00000240764+ENSG00000253731+ENSG00000254221+ENSG00000081853+ENSG00000253305+ENSG00000254122:008"
# "ENSG00000261934+ENSG00000253910+ENSG00000204956+ENSG00000253159+ENSG00000242419+ENSG00000253846+ENSG00000262209+ENSG00000253485+ENSG00000253767+ENSG00000240184+ENSG00000240764+ENSG00000253731+ENSG00000254221+ENSG00000081853+ENSG00000253305+ENSG00000254122:009"
# "ENSG00000261934+ENSG00000253910+ENSG00000204956+ENSG00000253159+ENSG00000242419+ENSG00000253846+ENSG00000262209+ENSG00000253485+ENSG00000253767+ENSG00000240184+ENSG00000240764+ENSG00000253731+ENSG00000254221+ENSG00000081853+ENSG00000253305+ENSG00000254122:010"
# "ENSG00000261934+ENSG00000253910+ENSG00000204956+ENSG00000253159+ENSG00000242419+ENSG00000253846+ENSG00000262209+ENSG00000253485+ENSG00000253767+ENSG00000240184+ENSG00000240764+ENSG00000253731+ENSG00000254221+ENSG00000081853+ENSG00000253305+ENSG00000254122:011"
# "ENSG00000261934+ENSG00000253910+ENSG00000204956+ENSG00000253159+ENSG00000242419+ENSG00000253846+ENSG00000262209+ENSG00000253485+ENSG00000253767+ENSG00000240184+ENSG00000240764+ENSG00000253731+ENSG00000254221+ENSG00000081853+ENSG00000253305+ENSG00000254122:012"
# "ENSG00000261934+ENSG00000253910+ENSG00000204956+ENSG00000253159+ENSG00000242419+ENSG00000253846+ENSG00000262209+ENSG00000253485+ENSG00000253767+ENSG00000240184+ENSG00000240764+ENSG00000253731+ENSG00000254221+ENSG00000081853+ENSG00000253305+ENSG00000254122:013"
# "ENSG00000261934+ENSG00000253910+ENSG00000204956+ENSG00000253159+ENSG00000242419+ENSG00000253846+ENSG00000262209+ENSG00000253485+ENSG00000253767+ENSG00000240184+ENSG00000240764+ENSG00000253731+ENSG00000254221+ENSG00000081853+ENSG00000253305+ENSG00000254122:014"
# "ENSG00000261934+ENSG00000253910+ENSG00000204956+ENSG00000253159+ENSG00000242419+ENSG00000253846+ENSG00000262209+ENSG00000253485+ENSG00000253767+ENSG00000240184+ENSG00000240764+ENSG00000253731+ENSG00000254221+ENSG00000081853+ENSG00000253305+ENSG00000254122:015"
# "ENSG00000261934+ENSG00000253910+ENSG00000204956+ENSG00000253159+ENSG00000242419+ENSG00000253846+ENSG00000262209+ENSG00000253485+ENSG00000253767+ENSG00000240184+ENSG00000240764+ENSG00000253731+ENSG00000254221+ENSG00000081853+ENSG00000253305+ENSG00000254122:016"
# "ENSG00000261934+ENSG00000253910+ENSG00000204956+ENSG00000253159+ENSG00000242419+ENSG00000253846+ENSG00000262209+ENSG00000253485+ENSG00000253767+ENSG00000240184+ENSG00000240764+ENSG00000253731+ENSG00000254221+ENSG00000081853+ENSG00000253305+ENSG00000254122:017"
# "ENSG00000261934+ENSG00000253910+ENSG00000204956+ENSG00000253159+ENSG00000242419+ENSG00000253846+ENSG00000262209+ENSG00000253485+ENSG00000253767+ENSG00000240184+ENSG00000240764+ENSG00000253731+ENSG00000254221+ENSG00000081853+ENSG00000253305+ENSG00000254122:018"
# "ENSG00000261934+ENSG00000253910+ENSG00000204956+ENSG00000253159+ENSG00000242419+ENSG00000253846+ENSG00000262209+ENSG00000253485+ENSG00000253767+ENSG00000240184+ENSG00000240764+ENSG00000253731+ENSG00000254221+ENSG00000081853+ENSG00000253305+ENSG00000254122:019"
# "ENSG00000261934+ENSG00000253910+ENSG00000204956+ENSG00000253159+ENSG00000242419+ENSG00000253846+ENSG00000262209+ENSG00000253485+ENSG00000253767+ENSG00000240184+ENSG00000240764+ENSG00000253731+ENSG00000254221+ENSG00000081853+ENSG00000253305+ENSG00000254122:020"
# "ENSG00000261934+ENSG00000253910+ENSG00000204956+ENSG00000253159+ENSG00000242419+ENSG00000253846+ENSG00000262209+ENSG00000253485+ENSG00000253767+ENSG00000240184+ENSG00000240764+ENSG00000253731+ENSG00000254221+ENSG00000081853+ENSG00000253305+ENSG00000254122:021"
# "ENSG00000261934+ENSG00000253910+ENSG00000204956+ENSG00000253159+ENSG00000242419+ENSG00000253846+ENSG00000262209+ENSG00000253485+ENSG00000253767+ENSG00000240184+ENSG00000240764+ENSG00000253731+ENSG00000254221+ENSG00000081853+ENSG00000253305+ENSG00000254122:022"
# "ENSG00000261934+ENSG00000253910+ENSG00000204956+ENSG00000253159+ENSG00000242419+ENSG00000253846+ENSG00000262209+ENSG00000253485+ENSG00000253767+ENSG00000240184+ENSG00000240764+ENSG00000253731+ENSG00000254221+ENSG00000081853+ENSG00000253305+ENSG00000254122:023"
# "ENSG00000261934+ENSG00000253910+ENSG00000204956+ENSG00000253159+ENSG00000242419+ENSG00000253846+ENSG00000262209+ENSG00000253485+ENSG00000253767+ENSG00000240184+ENSG00000240764+ENSG00000253731+ENSG00000254221+ENSG00000081853+ENSG00000253305+ENSG00000254122:024"
# "ENSG00000261934+ENSG00000253910+ENSG00000204956+ENSG00000253159+ENSG00000242419+ENSG00000253846+ENSG00000262209+ENSG00000253485+ENSG00000253767+ENSG00000240184+ENSG00000240764+ENSG00000253731+ENSG00000254221+ENSG00000081853+ENSG00000253305+ENSG00000254122:025"
# "ENSG00000261934+ENSG00000253910+ENSG00000204956+ENSG00000253159+ENSG00000242419+ENSG00000253846+ENSG00000262209+ENSG00000253485+ENSG00000253767+ENSG00000240184+ENSG00000240764+ENSG00000253731+ENSG00000254221+ENSG00000081853+ENSG00000253305+ENSG00000254122:026"
# "ENSG00000261934+ENSG00000253910+ENSG00000204956+ENSG00000253159+ENSG00000242419+ENSG00000253846+ENSG00000262209+ENSG00000253485+ENSG00000253767+ENSG00000240184+ENSG00000240764+ENSG00000253731+ENSG00000254221+ENSG00000081853+ENSG00000253305+ENSG00000254122:027"
# "ENSG00000261934+ENSG00000253910+ENSG00000204956+ENSG00000253159+ENSG00000242419+ENSG00000253846+ENSG00000262209+ENSG00000253485+ENSG00000253767+ENSG00000240184+ENSG00000240764+ENSG00000253731+ENSG00000254221+ENSG00000081853+ENSG00000253305+ENSG00000254122:028"
# "ENSG00000261934+ENSG00000253910+ENSG00000204956+ENSG00000253159+ENSG00000242419+ENSG00000253846+ENSG00000262209+ENSG00000253485+ENSG00000253767+ENSG00000240184+ENSG00000240764+ENSG00000253731+ENSG00000254221+ENSG00000081853+ENSG00000253305+ENSG00000254122:029"
# "ENSG00000261934+ENSG00000253910+ENSG00000204956+ENSG00000253159+ENSG00000242419+ENSG00000253846+ENSG00000262209+ENSG00000253485+ENSG00000253767+ENSG00000240184+ENSG00000240764+ENSG00000253731+ENSG00000254221+ENSG00000081853+ENSG00000253305+ENSG00000254122:030"
# "ENSG00000261934+ENSG00000253910+ENSG00000204956+ENSG00000253159+ENSG00000242419+ENSG00000253846+ENSG00000262209+ENSG00000253485+ENSG00000253767+ENSG00000240184+ENSG00000240764+ENSG00000253731+ENSG00000254221+ENSG00000081853+ENSG00000253305+ENSG00000254122:031"

mergedToRemove = gsub(pattern = ":E", replacement = ":",x = mergedToRemove)
y = which(rownames(exonCounts) %in% mergedToRemove)


metadataMatching = metadataFiltered[which(metadataFiltered$Px_Code %in% colnames(exonCounts)),]
rownames(metadataMatching) = metadataMatching$Px_Code
colnames(metadataMatching)
colnames(metadataMatching)[which(colnames(metadataMatching) == "caseStatus")] = "condition"
metadataFormatted = metadataMatching[,-1]
head(metadataFormatted)
levels(metadataFormatted$condition)
metadataFormatted$condition = relevel(metadataFormatted$condition,ref = "control")
levels(metadataFormatted$condition)

data.dex = DEXSeqDataSetFromFeatureCounts(countData = exonCounts[-y,],sampleData = metadataFormatted ,flattenedfile = getFileLocation(gtfEnt))
#data.dex = DEXSeqDataSet(countfile = exonCounts[-y,],sampleData = metadataFormatted, featureID = ,groupID = ,featureRanges = ,transcripts = )
data.dex = estimateSizeFactors(data.dex)

rm(exonCounts)
gc()
```


## QC analysis
```{r}
# Density plots
allCounts.norm = log2(featureCounts(data.dex,normalized=TRUE))
dim(allCounts.norm)
head(allCounts.norm)
plot(density(allCounts.norm[,1]), col = "blue", main = "norm data", ylim = range(0,1))
for (i in 2:ncol(allCounts.norm)) { lines(density(allCounts.norm[,i]), col = "blue") }

# Median - IQR
meds = apply(pc_counts,MARGIN = 2,FUN = median,na.rm = TRUE)
iqrs = apply(pc_counts,MARGIN = 2,FUN = IQR, na.rm = TRUE)
plot(meds,iqrs, xlab = "medians", ylab = "interquartile ranges", main = "log2(CPM) protein-coding genes")
abline(h = 8.6, col = "sandybrown", lty = 2)
abline(v = 2.98, col = "sandybrown", lty = 2)
which(iqrs > 8.6)
which(meds < 2.98)

```




```{r}
data.dex = estimateDispersions(data.dex)
plotDispEsts(data.dex)
dxd = testForDEU( dxd )
dxd = estimateExonFoldChanges( dxd, fitExpToVar="condition")
dxr1 = DEXSeqResults( dxd )

```