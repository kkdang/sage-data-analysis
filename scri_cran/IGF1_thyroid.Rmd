---
title: "IGF1_tyroid.Rmd"
author: "Kristen Dang"
date: "08/26/2016"
output:
  html_document:
    fig_height: 7
---

```{r message=FALSE,warning=FALSE}
library(synapseClient)
synapseLogin()
library("VennDiagram")
library('gplots')
library('RColorBrewer')
library('githubr')
source('/Users/kkdang/Computing/rgithubclient_authenticate.R')
sourceRepoFile(sageCode, 'scri_cran/cranio_common_routines.R')
sourceRepoFile(sageCode, 'biomart_fxns.R')
setwd('~/Computing/cranio/')
```


```{r}
#Gene gene lists
geneNames = read.delim("~/Downloads/ENSGv87_geneHGNC.txt", header = TRUE)
head(geneNames)

CunninghamGL = read.csv(getFileLocation(synGet('syn3105988')))
head(CunninghamGL)
# adding ENSG IDs
CunninghamGL[,6] = geneNames$Ensembl.Gene.ID[match(CunninghamGL$gene, geneNames$HGNC.symbol)]


#Get dataset, protein-coding genes, PALX=20%, with minimal model
sourceRepoFile(sageCode, 'scri_cran/make_residualized_dataset.R')
#proteinCoding_genes = getByBiotype()
```



Same model as above, but also controlling for sex
```{r}
## Run model and get residuals
minimalSetPlusSex = c("Age_mos.","PCT_CORRECT_STRAND_READS","PCT_INTRONIC_BASES", "Initial_growth_duration_days", "Sex")
tempModel = model.matrix(as.formula(paste("~",paste(minimalSetPlusSex,collapse = "+"),sep = "")), data = metadataMatching)
data.voom = voom(palx20.dge,tempModel,plot=FALSE) 
fit = lmFit(data.voom,tempModel)
residSex = residuals(fit,y = data.voom)

```

Functions
```{r}
phenoEnrich=function(queryGeneSet,universeGeneSet,queryAgainstGeneSet){
  contingency = matrix(NA,nrow = 2,ncol = 2,dimnames = list(c("query","all"),c("Group","other")))  
  phenoGenes = queryAgainstGeneSet
  contingency[1,1] = length(which(queryGeneSet %in% phenoGenes))
  contingency[1,2] = length(queryGeneSet) - contingency[1,1]
  contingency[2,1] = length(which(universeGeneSet %in% phenoGenes))
  contingency[2,2] = length(universeGeneSet) - contingency[2,1]
  test = fisher.test(contingency)
  print(test)
  return(test)
}
```


### IGF1 & Thyroid
```{r}
# Gene genes significantly correlated with IGF1 in cases
IGF1ensg = as.character(CunninghamGL$V6[which(CunninghamGL$gene == "IGF1")])
IGF1resid = resid[which(rownames(resid) == IGF1ensg),]


# What are the correlation estimates
IGF1cor = apply(resid,MARGIN = 1,function(z){cor.test(z,IGF1resid)$estimate})
hist(IGF1cor)
#x = apply(resid,MARGIN = 1,function(z){cor.test(z,IGF1resid)$p.value})
IGF1sig = p.adjust(apply(resid,MARGIN = 1,function(z){cor.test(z,IGF1resid)$p.value}),method = "fdr")
hist(IGF1sig)


# How many are significant?
length(which(IGF1sig < 0.01))
topHits = intersect(which(IGF1sig < 0.01), which(abs(IGF1cor) > 0.5))
length(topHits)

# Enrichment in Thyroid pathway?
thyFisher = phenoEnrich(queryGeneSet =  rownames(resid)[topHits],universeGeneSet = rownames(resid),queryAgainstGeneSet = unique(na.omit(CunninghamGL$V6[which(CunninghamGL$Thyroid == "YES")])))


# Other enrichment?
# library(ReactomePA)
# pathEnrich = enrichPathway(gene=HCentrez,universe = universeEntrez, readable=T)
# head(summary(HC_path))
# barplot(HC_path,showCategory = 25, main = "HC genes")
# enrichMap(HC_path)

```


Heatmaps 
```{r}
### clustered -- all top hits
heatmap.2(resid[topHits,],labRow="",trace='n',col=bluered,scale='r',dendrogram = "column")

### clustered -- thyroid top hits
plotCols = c("yellowgreen","gray85")
topThy = intersect(na.omit(CunninghamGL$V6[CunninghamGL$Thyroid == "YES"]),rownames(resid)[topHits])
topThyHGNC = geneNames$HGNC.symbol[match(topThy, geneNames$Ensembl.Gene.ID)]
heatmap.2(resid[which(rownames(resid) %in% topThy),],labRow="",trace='n',col=bluered,scale='r',ColSideColors=plotCols[as.numeric(metadataMatching$caseStatus)],dendrogram = "column")




### ordered by IGF1
IGF1residOrdered = IGF1resid[order(IGF1resid)]
residOrdered = resid[,match(names(IGF1residOrdered),colnames(resid))]

heatmap.2(resid[which(rownames(resid) %in% topThy),],labRow="",trace='n',col=bluered,scale='r',dendrogram = "none",Colv=NULL,key = FALSE)


```

To do:
1. Review the IGF1-ordered plot again.
2. Add HGNC symbols to small heatmap of thyroid-top hits.
3. Expand tophits and plot again.
4. Plot heatmap of all Thyroid genes, ordered by IGF1 expression
5. Other pathway enrich?